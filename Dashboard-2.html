<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Map-WasteCheck</title>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link 
    rel="icon" 
    type="image/png" 
    href="data:image/png;base64,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"
    >

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }

        .custom-text-label {
            background-color: #fff; color: #333; padding: 0px 6px; border-radius: 5px; font-size: 12px; font-weight: bold; box-shadow: 0 1px 4px rgba(0,0,0,0.3); white-space: nowrap; pointer-events: none; margin: 0;
        }
        .red-dot-marker {
            width: 10px; height: 10px; background-color: #FF0000; border-radius: 100%; border: 1px solid white; box-shadow: 0 0 1px rgba(0,0,0,0.5); pointer-events: auto;
        }
        #bearing-info, #zoom-info, #distance-info {
            position: absolute; background-color: rgba(255,255,255,0.9); border: 1px solid #333; border-radius: 6px; font-weight: bold; font-size: 14px; z-index: 1; padding: 5px 10px;
        }
        #bearing-info { top: 10px; left: 10px; }
        #zoom-info    { top: 10px; right: 10px; }
        #distance-info { bottom: 10px; left: 10px; white-space: pre-line; }

        .maplibregl-ctrl-group > button,
        .maplibregl-ctrl-group > .maplibregl-ctrl-icon,
        .maplibregl-ctrl-group > .reset-button,
        .maplibregl-ctrl-group > .toggle-table-button {
            width: 28px; height: 28px; margin: 2px; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid rgba(0,0,0,0.12); box-shadow: 0 1px 4px rgba(0,0,0,0.15); cursor: pointer; padding: 0;
        }
        .maplibregl-ctrl-group > button:hover,
        .maplibregl-ctrl-group > .reset-button:hover,
        .maplibregl-ctrl-group > .toggle-table-button:hover {
            background: #f0f0f0; transform: scale(1.04);
        }
        .reset-button span { font-size: 16px; line-height: 1; display: inline-block; transform: translateY(-1px); }

        .toggle-table-button.active { background-color: #333 !important; color: white; }
        .toggle-table-button.active:hover { background-color: #555 !important; color: white; }

        #data-table-container {
            position: absolute; top: 5px; left: 5px;
            width: auto; height: auto; max-width: 90vw; max-height: 120vh;
            background: rgba(255, 255, 255, 0.95); border: 1px solid #777; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 10; display: none; overflow: hidden; flex-direction: column;
        }

        #window-header {
            background-color: #333; color: white; padding: 2px 5px; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: bold; flex-shrink: 0; line-height: 0.8; font-size: 11px;
        }
        #window-header .control-buttons { display: flex; gap: 2px; }
        #window-header .control-buttons button {
            background: none; border: none; color: white; font-size: 11px; cursor: pointer; line-height: 1; width: 30px; height: 25px; display: flex; align-items: center; justify-content: center; border-radius: 3px; transition: background-color 0.2s;
        }
        #window-header .control-buttons button:hover { background-color: rgba(255, 255, 255, 0.2); }
        #window-header #close-window-btn:hover { background-color: #e74c3c; }

        #data-table-wrapper { padding: 5px; overflow: visible; }
        #data-table { border-collapse: collapse; width: 100%; font-size: 11px; }
        #data-table th, #data-table td { border: 1px solid #ddd; padding: 6px 10px; text-align: left; line-height: 0.9; }
        #data-table th { background-color: #f2f2f2; color: #333; font-weight: bold; }

    </style>
</head>
<body>
    <div id="map"></div>

    <div id="bearing-info" style="display:none;">Bearing: -45.60°</div>
    <div id="zoom-info" style="display:none;">Zoom: 15.65</div>
    <div id="distance-info" style="display:none;">
        พิกัด: 99.535692, 11.231666
        ระยะไปขอบล่าง: [กำลังคำนวณ] km 
        ระยะไปขอบซ้าย: [กำลังคำนวณ] km
    </div>

    <div id="data-table-container">
        <div id="window-header">
            <span>ตารางข้อมูลพื้นที่</span>
            <div class="control-buttons">
                <button id="close-window-btn" title="ปิดตาราง"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="data-table-wrapper">
            <table id="data-table">
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script>
        const targetLngLat = [99.535692, 11.231666];
        const desiredOffsetSouth = 0.0010;
        const desiredOffsetWest  = 0.0000;
        const initialBearing = -45.6;
        const initialZoom = 15.5;
        const initialPitch = 0;

        const map = new maplibregl.Map({
            container: 'map',
            style: { version: 8, sources: { satellite: { type:'raster', tiles:['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize:256 } }, layers:[{id:'satellite', type:'raster', source:'satellite'}] },
            center: [targetLngLat[0] - desiredOffsetWest, targetLngLat[1] - desiredOffsetSouth],
            zoom: initialZoom,
            bearing: initialBearing,
            pitch: initialPitch,
            maxZoom: 17.39
        });

        // ----------------------------
        // Custom Controls
        // ----------------------------
        class ResetControl {
            onAdd(mapInstance) {
                this.map = mapInstance;
                this.container = document.createElement('div');
                this.container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
                const btn = document.createElement('button');
                btn.className = 'reset-button';
                btn.type = 'button';
                btn.title = 'รีเซ็ตมุมมองแผนที่';
                btn.innerHTML = '<span>⟳</span>';
                btn.addEventListener('click', (e) => { e.stopPropagation(); this.map.easeTo({ center: targetLngLat, zoom: initialZoom, bearing: initialBearing, pitch: initialPitch, duration: 800 }); });
                this.container.appendChild(btn);
                return this.container;
            }
            onRemove() {}
        }

        class ToggleTableControl {
            onAdd(mapInstance) {
                this.map = mapInstance;
                this.container = document.createElement('div');
                this.container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
                this.btn = document.createElement('button');
                this.btn.className = 'toggle-table-button';
                this.btn.type = 'button';
                this.btn.title = 'แสดง/ซ่อนตารางข้อมูล';
                this.btn.innerHTML = '<i class="fas fa-table" id="toggle-table-icon"></i>'; 
                this.btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const container = document.getElementById('data-table-container');
                    if(container.style.display==='none'||container.style.display===''){ container.style.display='flex'; this.btn.classList.add('active'); this.btn.title='ซ่อนตารางข้อมูล'; }
                    else { container.style.display='none'; this.btn.classList.remove('active'); this.btn.title='แสดงตารางข้อมูล'; }
                });
                this.container.appendChild(this.btn);
                return this.container;
            }
            onRemove() {}
        }

        map.on('load', () => {
            map.addControl(new maplibregl.NavigationControl({ visualizePitch:true }), 'bottom-right');
            map.addControl(new ResetControl(), 'bottom-right');
            map.addControl(new ToggleTableControl(), 'bottom-right'); 

            updateBearing(); updateZoom(); updateDistances();
            loadLocations();
        });

        // ----------------------------
        // Info Updates
        // ----------------------------
        const bearingInfo = document.getElementById('bearing-info');
        const zoomInfo    = document.getElementById('zoom-info');
        const distanceInfo = document.getElementById('distance-info');

        function updateBearing(){ bearingInfo.innerText=`Bearing: ${map.getBearing().toFixed(2)}°`; }
        function updateZoom(){ zoomInfo.innerText=`Zoom: ${map.getZoom().toFixed(2)}`; }
        function updateDistances(){
            const bottom = [targetLngLat[0], targetLngLat[1]-0.01]; 
            const left   = [targetLngLat[0]-0.01, targetLngLat[1]]; 
            distanceInfo.innerText = `พิกัด: ${targetLngLat[0]}, ${targetLngLat[1]}\nระยะไปขอบล่าง: ${turf.distance(turf.point(targetLngLat), turf.point(bottom)).toFixed(3)} km\nระยะไปขอบซ้าย: ${turf.distance(turf.point(targetLngLat), turf.point(left)).toFixed(3)} km`;
        }

        map.on('move', ()=>{ updateBearing(); updateZoom(); updateDistances(); });

        // ----------------------------
        // Drag Table
        // ----------------------------
        const tableContainer = document.getElementById('data-table-container');
        const windowHeader = document.getElementById('window-header');
        windowHeader.onmousedown = dragMouseDown;
        function dragMouseDown(e){
            e.preventDefault();
            let pos3 = e.clientX, pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
            function elementDrag(e){
                e.preventDefault();
                let pos1 = pos3 - e.clientX, pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                tableContainer.style.top = (tableContainer.offsetTop - pos2) + "px";
                tableContainer.style.left = (tableContainer.offsetLeft - pos1) + "px";
            }
            function closeDragElement(){ document.onmouseup=null; document.onmousemove=null; }
        }
        document.getElementById('close-window-btn').onclick = ()=>{ tableContainer.style.display='none'; document.querySelector('.toggle-table-button').classList.remove('active'); }

        // ----------------------------
        // Load Locations from Google Apps Script
        // ----------------------------
        let locations = [];
        const tableBody = document.querySelector('#data-table tbody');

        async function loadLocations(){
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbzdYdBwnBhdixvyp4sjTwcSjSGUUM0TCXCVmABjt58A--TUOplaeXztj5yCp0Kt_6shAw/exec');
                const data = await response.json(); // [{id:1,name:"xxx",lat:xx,lng:xx},...]
                locations = data;
                populateTable();
                addMarkers();
            } catch(err){ console.error('Error fetching locations:', err); }
        }

        function populateTable(){
            tableBody.innerHTML = '';
            locations.forEach(loc => {
                const row = tableBody.insertRow();
                const idCell = row.insertCell();
                const nameCell = row.insertCell();
                idCell.textContent = loc.id;
                nameCell.textContent = loc.name;
            });
        }

// ----------------------------
// Label Offset Map
// ----------------------------
const labelOffsetMap = {
    top:    [0, -10],
    right:  [20, 10],
    bottom: [0, 30],
    left:   [-20, 10]
};

// ----------------------------
// Add Markers with Labels
// ----------------------------
function addMarkers(){
    locations.forEach(loc=>{
        // Marker
        const markerDiv = document.createElement('div');
        markerDiv.className='red-dot-marker';
        new maplibregl.Marker({element:markerDiv, anchor:'center'})
            .setLngLat([loc.lng, loc.lat])
            .addTo(map);

        // Label
        const labelDiv = document.createElement('div');
        labelDiv.className='custom-text-label';
        labelDiv.innerText = loc.id;

        // ใช้ labelPos จาก Sheet, default เป็น 'top' ถ้าไม่มีหรือผิด
        const position = loc.labelPos?.toLowerCase();
        const offset = labelOffsetMap[position] || labelOffsetMap.top;

        new maplibregl.Marker({element:labelDiv, anchor:'bottom', offset: offset})
            .setLngLat([loc.lng, loc.lat])
            .setPopup(new maplibregl.Popup({offset:25}).setText(loc.name))
            .addTo(map);
    });
}

    </script>
</body>
</html>
