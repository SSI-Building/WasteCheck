<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Map-WasteCheck (Mobile UI)</title>
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<style>
    /* --- พื้นฐาน --- */
    body { margin:0; padding:0; font-family: sans-serif; overflow: hidden; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* --- คง Marker & Label ไว้ตามต้นฉบับ --- */
    .custom-text-label { background-color:#fff;color:#333;padding:0px 6px;border-radius:5px;font-size:12px;font-weight:bold;box-shadow:0 1px 4px rgba(0,0,0,0.3);white-space:nowrap;pointer-events:none;margin:0;}
    .red-dot-marker { width:10px;height:10px;background-color:#FF0000;border-radius:100%;border:1px solid white;box-shadow:0 0 1px rgba(0,0,0,0.5);pointer-events:auto; }
    .green-dot-marker { width:10px;height:10px;background-color:#00FF00;border-radius:100%;border:1px solid white;box-shadow:0 0 1px rgba(0,0,0,0.5);pointer-events:auto; }

    /* --- ปรับปรุงส่วนควบคุมด้านบน (Top Bar) --- */
    .top-controls {
        position: absolute; top: 10px; left: 10px; right: 10px;
        display: flex; gap: 8px; z-index: 50; pointer-events: none;
    }
    #datepicker-container {
        background: white; padding: 8px 12px; border-radius: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2); pointer-events: auto;
        display: flex; align-items: center;
    }
    #datePicker { border: none; font-size: 14px; outline: none; font-weight: bold; }

    /* --- ข้อมูลแผนที่ (ขนาดเล็กลงสำหรับมือถือ) --- */
    #info-panel {
        position: absolute; top: 60px; left: 10px; z-index: 1;
        background: rgba(255,255,255,0.7); padding: 4px 8px;
        border-radius: 5px; font-size: 10px; pointer-events: none;
    }

    /* --- Floating Action Buttons (ปุ่มมุมขวาล่าง) --- */
    .fab-container {
        position: absolute; bottom: 30px; right: 15px;
        display: flex; flex-direction: column; gap: 12px; z-index: 100;
    }
    .fab {
        width: 55px; height: 55px; border-radius: 50%;
        border: none; color: white; font-size: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: transform 0.1s;
    }
    .fab:active { transform: scale(0.9); }
    .fab-table { background-color: #333; }
    .fab-add { background-color: #27ae60; }
    .fab-reset { background-color: #fff; color: #333; }
    .fab-performance { background-color: #3498db; }

    /* --- ตารางข้อมูล (Bottom Sheet) --- */
    #data-table-container {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 1000;
        display: none; flex-direction: column; max-height: 70vh;
    }
    #window-header {
        padding: 15px; border-bottom: 1px solid #eee;
        display: flex; justify-content: space-between; align-items: center;
    }
    #data-table-wrapper { overflow-y: auto; padding: 10px; flex: 1; }
    #data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    #data-table th, #data-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }

    /* --- ฟอร์มเพิ่มพิกัด (Fullscreen Modal) --- */
    #add-location-form-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.98); z-index: 2000;
        display: none; padding: 20px; box-sizing: border-box;
    }
    #add-location-form-container h3 { margin-top: 40px; }
    .mobile-input {
        width: 100%; padding: 15px; margin-bottom: 15px;
        border: 1px solid #ddd; border-radius: 10px; font-size: 16px;
    }
    .btn-group { display: flex; gap: 10px; }
    .mobile-btn {
        flex: 1; padding: 15px; border-radius: 10px; border: none;
        font-weight: bold; font-size: 16px;
    }

    /* --- Loading --- */
    #loading-overlay {
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.6); z-index:9999;
        display:none; flex-direction:column; align-items:center; justify-content:center; color:white;
    }
</style>
</head>
<body>

<div id="map"></div>

<div class="top-controls">
    <div id="datepicker-container">
        <i class="far fa-calendar-alt" style="margin-right:8px; color:#666;"></i>
        <input type="date" id="datePicker">
    </div>
</div>

<div id="info-panel">
    <div id="bearing-info">Bearing: 0°</div>
    <div id="zoom-info">Zoom: 0</div>
    <div id="distance-info">พิกัดแกน</div>
</div>

<div class="fab-container">
    <button class="fab fab-performance" onclick="location.href='https://ssi-building.github.io/WasteCheck/WastePerformance.html'"><i class="fas fa-chart-bar"></i></button>
    <button class="fab fab-reset" id="reset-view-btn">⟳</button>
    <button class="fab fab-add" id="open-add-btn"><i class="fas fa-map-pin"></i></button>
    <button class="fab fab-table" id="toggle-table-btn"><i class="fas fa-table"></i></button>
</div>

<div id="data-table-container">
    <div id="window-header">
        <strong style="font-size:18px;">ตารางข้อมูลพื้นที่</strong>
        <button id="close-table-btn" style="background:none; border:none; font-size:24px;">&times;</button>
    </div>
    <div id="data-table-wrapper">
        <table id="data-table">
            <thead>
                <tr><th>ID</th><th>พื้นที่</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="add-location-form-container">
    <h3>ทดสอบปักหมุด</h3>
    <form id="add-location-form">
        <input type="text" id="new-name" class="mobile-input" placeholder="ชื่อพื้นที่" required>
        <input type="number" step="0.000001" id="new-lat" class="mobile-input" placeholder="Latitude" required>
        <input type="number" step="0.000001" id="new-lng" class="mobile-input" placeholder="Longitude" required>
        <select id="new-label-pos" class="mobile-input">
            <option value="top">Label: Top</option>
            <option value="right">Right</option>
            <option value="bottom">Bottom</option>
            <option value="left">Left</option>
        </select>
        <div class="btn-group">
            <button type="button" id="preview-btn" class="mobile-btn" style="background:#3498db; color:white;">รีวิวบนแผนที่</button>
            <button type="button" id="clear-preview-btn" class="mobile-btn" style="background:#e74c3c; color:white;"><i class="fas fa-trash"></i></button>
        </div>
        <div class="btn-group" style="margin-top:10px;">
            <button type="submit" class="mobile-btn" style="background:#27ae60; color:white;">บันทึกข้อมูล</button>
            <button type="button" id="close-add-location-btn" class="mobile-btn" style="background:#eee;">ยกเลิก</button>
        </div>
    </form>
</div>

<div id="loading-overlay">
    <i class="fas fa-spinner fa-spin fa-3x"></i>
    <div style="margin-top:10px;">กำลังโหลด...</div>
</div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
// --- ค่าเริ่มต้นคงเดิม ---
const targetLngLat = [99.535692, 11.231666];
const desiredOffsetSouth = 0.0010;
const desiredOffsetWest = -0.0010;
const initialBearing = -45.6;
const initialZoom = 15.58;

// ตั้งวันที่ DatePicker
const datePicker = document.getElementById('datePicker');
datePicker.valueAsDate = new Date();

const map = new maplibregl.Map({
    container:'map',
    style:{version:8,sources:{satellite:{type:'raster',tiles:['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],tileSize:256}},layers:[{id:'satellite',type:'raster',source:'satellite'}]},
    center:[targetLngLat[0]-desiredOffsetWest,targetLngLat[1]-desiredOffsetSouth],
    zoom:initialZoom,
    bearing:initialBearing,
    maxZoom:17.4
});

// --- Logic การควมคุม UI ---

// เปิด-ปิด ตาราง
document.getElementById('toggle-table-btn').onclick = () => {
    document.getElementById('data-table-container').style.display = 'flex';
};
document.getElementById('close-table-btn').onclick = () => {
    document.getElementById('data-table-container').style.display = 'none';
};

// เปิด-ปิด ฟอร์มเพิ่มจุด
document.getElementById('open-add-btn').onclick = () => {
    document.getElementById('add-location-form-container').style.display = 'block';
};
document.getElementById('close-add-location-btn').onclick = () => {
    document.getElementById('add-location-form-container').style.display = 'none';
};

// รีเซ็ตมุมมอง
document.getElementById('reset-view-btn').onclick = () => {
    map.easeTo({
        center:[targetLngLat[0]-desiredOffsetWest,targetLngLat[1]-desiredOffsetSouth],
        zoom:initialZoom, bearing:initialBearing, pitch:0, duration:800
    });
    setTimeout(() => location.reload(), 900);
};

// อัปเดตข้อมูลบนหน้าจอ
map.on('move', () => {
    document.getElementById('bearing-info').innerText = `Bearing: ${map.getBearing().toFixed(2)}°`;
    document.getElementById('zoom-info').innerText = `Zoom: ${map.getZoom().toFixed(2)}`;
});

// ฟังก์ชันโหลดข้อมูล (Logic เดิมของคุณ)
function showLoading() { document.getElementById('loading-overlay').style.display='flex'; }
function hideLoading() { document.getElementById('loading-overlay').style.display='none'; }

function sendDateToScript(dateValue) {
    showLoading();
    fetch("https://script.google.com/macros/s/AKfycbwbKc57BpjSr2pZhpKl_UPu0LGGSfQ4x2B152n5lcovXoTMOLzaD_AkMIUc5m5ot-lFMg/exec?date=" + dateValue)
        .then(res => res.json())
        .then(() => loadLocations())
        .finally(() => hideLoading());
}

datePicker.onchange = () => sendDateToScript(datePicker.value);

let locations = [];
async function loadLocations(){
    try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbzdYdBwnBhdixvyp4sjTwcSjSGUUM0TCXCVmABjt58A--TUOplaeXztj5yCp0Kt_6shAw/exec');
        locations = await res.json();
        populateTable(); 
        addMarkers();
    } catch(err) { console.error(err); }
}

function populateTable(){
    const tableBody = document.querySelector('#data-table tbody');
    tableBody.innerHTML = locations.map(loc => `<tr><td>${loc.id}</td><td>${loc.name}</td></tr>`).join('');
}

const labelOffsetMap = { top:[0,-10], right:[20,10], bottom:[0,30], left:[-20,10] };

function addMarkers(){
    locations.forEach(loc => {
        let colorClass = loc.status === "Complete" ? "green-dot-marker" : "red-dot-marker";
        const markerDiv = document.createElement('div'); markerDiv.className = colorClass;
        new maplibregl.Marker({element: markerDiv, anchor:'center'}).setLngLat([loc.lng, loc.lat]).addTo(map);

        const labelDiv = document.createElement('div'); labelDiv.className='custom-text-label'; labelDiv.innerText = loc.id;
        const pos = loc.labelPos?.toLowerCase();
        const offset = labelOffsetMap[pos] || labelOffsetMap.top;
        new maplibregl.Marker({element:labelDiv, anchor:'bottom', offset:offset})
            .setLngLat([loc.lng, loc.lat])
            .setPopup(new maplibregl.Popup({offset:25}).setText(loc.name))
            .addTo(map);
    });
}

// Preview Logic 
let previewMarkers = [];
document.getElementById('preview-btn').onclick = () => {
    const lat = parseFloat(document.getElementById('new-lat').value);
    const lng = parseFloat(document.getElementById('new-lng').value);
    if(!lat || !lng) return alert("กรุณากรอกพิกัด");
    
    previewMarkers.forEach(m => m.remove());
    const m1 = new maplibregl.Marker().setLngLat([lng, lat]).addTo(map);
    previewMarkers = [m1];
    
    document.getElementById('add-location-form-container').style.display = 'none';
    map.flyTo({center: [lng, lat], zoom: 17});
};

document.getElementById('clear-preview-btn').onclick = () => {
    previewMarkers.forEach(m => m.remove());
};

map.on('load', () => {
    sendDateToScript(datePicker.value);
});
</script>
</body>
</html>
