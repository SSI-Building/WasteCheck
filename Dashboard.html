<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Map-WasteCheck</title>
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<style>
body { margin:0; padding:0; }
#map { position:absolute; top:0; bottom:0; width:100%; }

/* --- Markers / Labels --- */
.custom-text-label { background-color:#fff;color:#333;padding:0px 6px;border-radius:5px;font-size:12px;font-weight:bold;box-shadow:0 1px 4px rgba(0,0,0,0.3);white-space:nowrap;pointer-events:none;margin:0;}
.red-dot-marker { width:10px;height:10px;background-color:#FF0000;border-radius:100%;border:1px solid white;box-shadow:0 0 1px rgba(0,0,0,0.5);pointer-events:auto; }
.green-dot-marker { width:10px;height:10px;background-color:#00FF00;border-radius:100%;border:1px solid white;box-shadow:0 0 1px rgba(0,0,0,0.5);pointer-events:auto; }

/* --- Info --- */
#bearing-info,#zoom-info,#distance-info{position:absolute;background:rgba(255,255,255,0.9);border:1px solid #333;border-radius:6px;font-weight:bold;font-size:14px;z-index:1;padding:5px 10px;}
#bearing-info{top:10px;left:10px;}
#zoom-info{top:10px;right:10px;}
#distance-info{bottom:10px;left:10px;white-space:pre-line;}

/* --- Controls --- */
.maplibregl-ctrl-group > button,
.maplibregl-ctrl-group > .maplibregl-ctrl-icon,
.maplibregl-ctrl-group > .reset-button,
.maplibregl-ctrl-group > .toggle-table-button {
  width:28px;height:28px;margin:2px;border-radius:4px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid rgba(0,0,0,0.12);box-shadow:0 1px 4px rgba(0,0,0,0.15);cursor:pointer;padding:0;
}
.maplibregl-ctrl-group > button:hover,
.maplibregl-ctrl-group > .reset-button:hover,
.maplibregl-ctrl-group > .toggle-table-button:hover { background:#f0f0f0; transform: scale(1.04);}
.reset-button span{font-size:16px;line-height:1;display:inline-block;transform:translateY(-1px);}
.toggle-table-button.active{background-color:#333 !important;color:white;}
.toggle-table-button.active:hover{background-color:#555 !important;color:white;}

/* --- Table --- */
#data-table-container {
  position:absolute; top:5px; left:5px; width:auto;height:auto; max-width:90vw; max-height:120vh;
  background: rgba(255,255,255,0.95); border:1px solid #777; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.4);
  z-index:10; display:none; overflow:hidden; flex-direction:column;
}
#window-header{
  background-color:#333;color:white;padding:2px 5px;cursor:move;display:flex;justify-content:space-between;align-items:center;font-weight:bold;flex-shrink:0;line-height:0.8;font-size:11px;
}
#window-header .control-buttons button{
  background:none;border:none;color:white;font-size:11px;cursor:pointer;line-height:1;width:30px;height:25px;display:flex;align-items:center;justify-content:center;border-radius:3px;
}
#window-header .control-buttons button:hover{background-color:rgba(255,255,255,0.2);}
#window-header #close-window-btn:hover{background-color:#e74c3c;}

#data-table-wrapper { padding:5px; overflow:visible; }
#data-table { border-collapse:collapse; width:100%; font-size:11px;}
#data-table th,#data-table td{border:1px solid #ddd;padding:6px 10px;text-align:left;line-height:0.9;}
#data-table th{background-color:#f2f2f2;color:#333;font-weight:bold;}

/* --- Add Location --- */
#add-location-form-container {
  position: fixed; top:50%; left:50%; transform: translate(-50%,-50%);
  background: rgba(255,255,255,0.95); border:1px solid #777; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.4); z-index:20; display:none; padding:15px; width:260px;
}
#add-location-form-container h3{margin:0 0 10px 0;font-size:14px;text-align:center;}
#add-location-form input,#add-location-form select{width:100%;padding:5px 6px;margin-bottom:8px;font-size:12px;border:1px solid #ccc;border-radius:4px;}
#add-location-form button{width:48%;padding:5px;font-size:12px;border-radius:4px;cursor:pointer;border:none;margin-right:4%;}
#add-location-form button:last-child{margin-right:0;}
#add-location-form .save-btn{background-color:#27ae60;color:white;}
#add-location-form .cancel-btn{background-color:#e74c3c;color:white;}

/* --- Loading Overlay (ปรับปรุงใหม่) --- */
#loading-overlay {
    display:none;
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6); /* เพิ่มความเข้มพื้นหลัง */
    backdrop-filter: blur(2px); /* เบลอฉากหลัง */
    z-index:9999;
    flex-direction: column; /* จัดแนวตั้ง */
    align-items:center;
    justify-content:center;
    color:white;
    font-size:18px;
    font-weight:bold;
}

/* เพิ่มส่วนนี้เข้าไปในบล็อก <style> */
  #performance-button {
    position: absolute;
    bottom: 195px; /* กำหนดให้อยู่ด้านบน */
    right: 10px; /* เว้นระยะจากขวา (หลัง DatePicker) */
    z-index: 50;
    background-color: #3498db; /* สีฟ้า */
    color: white;
    border: none;
    padding: 6px 9px;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-weight: bold;
    font-size: 14px;
    font-family: sans-serif;
    transition: background-color 0.2s, transform 0.2s;
}

#performance-button:hover {
    background-color: #2980b9;
    transform: scale(1.02);
}
  
  
</style>
</head>
<body>
<div id="map"></div>

<div id="bearing-info" style="display:none;">Bearing: -45.60°</div>
<div id="zoom-info" style="display:none;">Zoom: 15.65</div>
<div id="distance-info" style="display:none;">พิกัด: 99.535692, 11.231666</div>

<div id="data-table-container">
  <div id="window-header">
    <span>ตารางข้อมูลพื้นที่</span>
    <div class="control-buttons">
      <button id="close-window-btn" title="ปิดตาราง"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <div id="data-table-wrapper">
    <table id="data-table">
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="add-location-form-container">
  <h3>ทดสอบปักหมุด</h3>
  <form id="add-location-form">
      <input type="text" id="new-name" placeholder="พื้นที่" required>
      <input type="number" step="0.000001" id="new-lat" placeholder="ละติจูด (Lat)" required>
      <input type="number" step="0.000001" id="new-lng" placeholder="ลองติจูด (Lng)" required>
      <select id="new-label-pos">
          <option value="top">Top</option>
          <option value="right">Right</option>
          <option value="bottom">Bottom</option>
          <option value="left">Left</option>
      </select>
      <div style="display:flex; justify-content:space-between; margin-top:5px;">
        <button type="button" class="review-btn" id="preview-btn" style="background-color:#3498db;color:white;border:none;padding:5px 8px;border-radius:4px;">
            <i class="fas fa-eye"></i> รีวิว
        </button>
        <button type="button" id="clear-preview-btn" style="background-color:#e74c3c;color:white;border:none;padding:5px 8px;border-radius:4px;">
            <i class="fas fa-trash"></i>
        </button>
        
        <button type="button" class="cancel-btn" id="close-add-location-btn">ยกเลิก</button>
    </div>
  </form>
</div>
<div id="datepicker-container" style="
    position: absolute;
    top: 9px;
    right: 50px;
    z-index: 50;
    background: white;
    padding: 6px 10px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: sans-serif;
">
    <input type="date" id="datePicker">
</div>

<div id="loading-overlay">
    <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 10px;"></i>
    <div>กำลังโหลดข้อมูล...</div>
</div>

<button id="performance-button" title="ดูแดชบอร์ดประสิทธิภาพ">
  <i class="fas fa-chart-bar"></i>
</button>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>

// ตั้งวันที่ DatePicker เป็นวันปัจจุบัน
const datePicker = document.getElementById('datePicker');
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
datePicker.value = `${yyyy}-${mm}-${dd}`;

const targetLngLat = [99.535692, 11.231666];
const desiredOffsetSouth = 0.0010;
const desiredOffsetWest  = -0.0010;
const initialBearing = -45.6;
const initialZoom = 15.58;
const initialPitch = 0;

const map = new maplibregl.Map({
    container:'map',
    style:{version:8,sources:{satellite:{type:'raster',tiles:['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],tileSize:256}},layers:[{id:'satellite',type:'raster',source:'satellite'}]},
    center:[targetLngLat[0]-desiredOffsetWest,targetLngLat[1]-desiredOffsetSouth],
    zoom:initialZoom,
    bearing:initialBearing,
    pitch:initialPitch,
    maxZoom:17.39
});

const bearingInfo = document.getElementById('bearing-info');
const zoomInfo = document.getElementById('zoom-info');
const distanceInfo = document.getElementById('distance-info');

// ฟังก์ชันควบคุม Loading
function showLoading() { document.getElementById('loading-overlay').style.display='flex'; }
function hideLoading() { document.getElementById('loading-overlay').style.display='none'; }

function updateBearing(){ bearingInfo.innerText=`Bearing: ${map.getBearing().toFixed(2)}°`; }
function updateZoom(){ zoomInfo.innerText=`Zoom: ${map.getZoom().toFixed(2)}`; }
function updateDistances(){
    const bottom=[targetLngLat[0], targetLngLat[1]-0.01];
    const left=[targetLngLat[0]-0.01, targetLngLat[1]];
    distanceInfo.innerText=`พิกัด: ${targetLngLat[0]}, ${targetLngLat[1]}\nระยะไปขอบล่าง: ${turf.distance(turf.point(targetLngLat),turf.point(bottom)).toFixed(3)} km\nระยะไปขอบซ้าย: ${turf.distance(turf.point(targetLngLat),turf.point(left)).toFixed(3)} km`;
}
map.on('move',()=>{updateBearing();updateZoom();updateDistances();});


// ----------------------
// --- ส่วนการโหลดข้อมูล (ปรับปรุงใหม่) ---
// ----------------------

// ฟังก์ชันหลักสำหรับส่งวันที่และโหลดข้อมูลใหม่
function sendDateToScript(dateValue) {
    // 1. เปิดหน้าโหลดทันที
    showLoading();
    console.log("Start fetching for date:", dateValue);

    // 2. ส่งวันที่ไปยัง GAS
    fetch("https://script.google.com/macros/s/AKfycbwbKc57BpjSr2pZhpKl_UPu0LGGSfQ4x2B152n5lcovXoTMOLzaD_AkMIUc5m5ot-lFMg/exec?date=" + dateValue)
        .then(res => res.json())
        .then(data => {
            console.log("Date sent successfully:", data);
            // 3. เมื่อส่งวันที่เสร็จ ให้เรียกโหลด Locations ต่อทันที
            // ต้อง return Promise เพื่อให้ finally ด้านล่างรอจนกว่า loadLocations จะเสร็จ
            return loadLocations(); 
        })
        .catch(err => {
            console.error("Error in process:", err);
            alert("เกิดข้อผิดพลาดในการโหลดข้อมูล");
        })
        .finally(() => {
            // 4. ปิดหน้าโหลดเสมอ ไม่ว่าจะสำเร็จหรือล้มเหลว (ทำงานหลัง loadLocations เสร็จ)
            hideLoading();
        });
}

// เมื่อผู้ใช้เปลี่ยนวันที่ใน DatePicker
datePicker.addEventListener('change', function() {
    sendDateToScript(this.value);
});


// ---------------- Controls ----------------
class ResetControl { onAdd(map){this.map=map;this.container=document.createElement('div');this.container.className='maplibregl-ctrl maplibregl-ctrl-group'; const btn=document.createElement('button'); btn.className='reset-button'; btn.type='button'; btn.title='รีเซ็ตมุมมองแผนที่'; btn.innerHTML='<span>⟳</span>'; 
btn.addEventListener('click', e => {
    e.stopPropagation();
    this.map.easeTo({
        center:[targetLngLat[0]-desiredOffsetWest,targetLngLat[1]-desiredOffsetSouth],
        zoom:initialZoom,
        bearing:initialBearing,
        pitch:initialPitch,
        duration:800
    });
    // รีเฟรชหน้า (ถ้าต้องการ)
    setTimeout(()=>{ location.reload(); }, 800); 
});

; this.container.appendChild(btn); return this.container;} onRemove(){} }
class ToggleTableControl { onAdd(map){this.map=map;this.container=document.createElement('div');this.container.className='maplibregl-ctrl maplibregl-ctrl-group'; this.btn=document.createElement('button'); this.btn.className='toggle-table-button'; this.btn.type='button'; this.btn.title='แสดง/ซ่อนตารางข้อมูล'; this.btn.innerHTML='<i class="fas fa-table"></i>'; this.btn.addEventListener('click',e=>{e.stopPropagation(); const container=document.getElementById('data-table-container'); if(container.style.display==='none'||container.style.display===''){ container.style.display='flex'; this.btn.classList.add('active'); this.btn.title='ซ่อนตารางข้อมูล'; } else { container.style.display='none'; this.btn.classList.remove('active'); this.btn.title='แสดงตารางข้อมูล'; } }); this.container.appendChild(this.btn); return this.container;} onRemove(){} }
class AddLocationControl { onAdd(map){this.map=map;this.container=document.createElement('div');this.container.className='maplibregl-ctrl maplibregl-ctrl-group'; this.btn=document.createElement('button'); this.btn.className='add-location-button'; this.btn.type='button'; this.btn.title='ทดสอบปักหมุด'; this.btn.innerHTML='<i class="fas fa-map-pin"></i>'; this.btn.addEventListener('click',e=>{e.stopPropagation(); document.getElementById('add-location-form-container').style.display='block';}); this.container.appendChild(this.btn); return this.container;} onRemove(){} }

map.on('load',()=>{
    map.addControl(new maplibregl.NavigationControl({visualizePitch:true}),'bottom-right');
    map.addControl(new ResetControl(),'bottom-right');
    map.addControl(new ToggleTableControl(),'bottom-right');
    map.addControl(new AddLocationControl(),'top-right');
    updateBearing(); updateZoom(); updateDistances();
    
    // เรียกโหลดข้อมูลครั้งแรกเมื่อแผนที่พร้อม
    sendDateToScript(datePicker.value);
});

// ---------------- Table Drag ----------------
const tableContainer = document.getElementById('data-table-container');
const windowHeader = document.getElementById('window-header');
dragElement(windowHeader, tableContainer);

document.getElementById('close-window-btn').onclick = ()=>{tableContainer.style.display='none';document.querySelector('.toggle-table-button').classList.remove('active');}

// ---------------- Add Drag ----------------
const addContainer = document.getElementById('add-location-form-container');
const addHeader = addContainer.querySelector('h3');
dragElement(addHeader, addContainer);

function dragElement(elmnt, container){
    elmnt.onmousedown = function(e){
        e.preventDefault();
        let pos3=e.clientX,pos4=e.clientY;
        document.onmouseup=closeDragElement;
        document.onmousemove=elementDrag;
        function elementDrag(e){
            e.preventDefault();
            let pos1=pos3-e.clientX,pos2=pos4-e.clientY;
            pos3=e.clientX; pos4=e.clientY;
            container.style.top=(container.offsetTop-pos2)+'px';
            container.style.left=(container.offsetLeft-pos1)+'px';
        }
        function closeDragElement(){document.onmouseup=null;document.onmousemove=null;}
    }
}

// ---------------- Locations ----------------
let locations=[];
const tableBody=document.querySelector('#data-table tbody');

async function loadLocations(){
    try{
        const response=await fetch('https://script.google.com/macros/s/AKfycbzdYdBwnBhdixvyp4sjTwcSjSGUUM0TCXCVmABjt58A--TUOplaeXztj5yCp0Kt_6shAw/exec');
        const data=await response.json();
        locations=data;
        populateTable(); addMarkers();
    }catch(err){
        console.error('Error fetching locations:',err);
        // ถ้า error ก็ให้โยน error ออกไปเพื่อให้ finally ใน sendDateToScript ทำงานได้ถูกต้อง
        throw err; 
    }
}

function populateTable(){
    tableBody.innerHTML='';
    locations.forEach(loc=>{
        const row=tableBody.insertRow();
        const idCell=row.insertCell(); const nameCell=row.insertCell();
        idCell.textContent=loc.id; nameCell.textContent=loc.name;
    });
}

// ---------------- Marker ----------------
const labelOffsetMap={ top:[0,-10], right:[20,10], bottom:[0,30], left:[-20,10] };

function addMarkers(){
    // ลบ Marker เก่าออกก่อน (ถ้ามีฟังก์ชัน remove หรือ clear) - ในโค้ดเก่ายังไม่มีการ clear marker เก่า
    // แต่เพื่อความปลอดภัยในการโหลดซ้ำ อาจจะต้องพิจารณาเพิ่มการ clearMarkers() ในอนาคต
    
    locations.forEach(loc => {
        let colorClass = loc.status === "Complete" ? "green-dot-marker" : "red-dot-marker";
        const markerDiv = document.createElement('div'); markerDiv.className = colorClass;
        new maplibregl.Marker({element: markerDiv, anchor:'center'}).setLngLat([loc.lng, loc.lat]).addTo(map);

        const labelDiv = document.createElement('div'); labelDiv.className='custom-text-label'; labelDiv.innerText = loc.id;
        const pos = loc.labelPos?.toLowerCase();
        const offset = labelOffsetMap[pos] || labelOffsetMap.top;
        new maplibregl.Marker({element:labelDiv, anchor:'bottom', offset:offset})
            .setLngLat([loc.lng, loc.lat])
            .setPopup(new maplibregl.Popup({offset:25}).setText(loc.name))
            .addTo(map);
    });
}

// ---------------- Add Location Form ----------------
document.getElementById('add-location-form').onsubmit=function(e){
    e.preventDefault();
    const name=document.getElementById('new-name').value;
    const lat=parseFloat(document.getElementById('new-lat').value);
    const lng=parseFloat(document.getElementById('new-lng').value);
    const labelPos=document.getElementById('new-label-pos').value;
    const newId=locations.length>0?Math.max(...locations.map(l=>l.id))+1:1;
    locations.push({id:newId,name:name,lat:lat,lng:lng,labelPos:labelPos});
    populateTable(); addMarkers();
    document.getElementById('add-location-form-container').style.display='none';
}

// Close add form
document.getElementById('close-add-location-btn').onclick = ()=>{addContainer.style.display='none';}

let previewMarker = null;

// รีวิว
document.getElementById('preview-btn').onclick = function() {
    const lat = parseFloat(document.getElementById('new-lat').value);
    const lng = parseFloat(document.getElementById('new-lng').value);
    const labelPos = document.getElementById('new-label-pos').value;

    if(previewMarker) { previewMarker.forEach(m => m.remove()); }
    previewMarker = [];

    const newId = locations.length > 0 ? Math.max(...locations.map(l => l.id)) + 1 : 1;

    const markerDiv = document.createElement('div'); markerDiv.className='red-dot-marker';
    const marker = new maplibregl.Marker({element: markerDiv, anchor:'center'}).setLngLat([lng,lat]).addTo(map);
    previewMarker.push(marker);

    const labelDiv = document.createElement('div'); labelDiv.className='custom-text-label'; labelDiv.innerText = newId;
    const offset = labelOffsetMap[labelPos.toLowerCase()] || labelOffsetMap.top;
    const labelMarker = new maplibregl.Marker({element: labelDiv, anchor:'bottom', offset: offset}).setLngLat([lng,lat]).addTo(map);
    previewMarker.push(labelMarker);

    map.flyTo({center:[lng,lat], zoom:17});
};

// เคลียร์ preview
document.getElementById('clear-preview-btn').onclick = function() {
    if(previewMarker) { previewMarker.forEach(m => m.remove()); previewMarker = null; }
};

document.getElementById('performance-button').addEventListener('click', function() {
    // ลิงก์ไปยัง URL ที่คุณต้องการ
    window.location.href = 'https://ssi-building.github.io/WasteCheck/WastePerformance.html';
});
</script>
</body>
</html>
