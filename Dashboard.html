<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Map Satellite + Controls + Distance</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* สไตล์สำหรับ Text Label แทน Popup */
    .custom-text-label {
      background-color: #fff;
      color: #333;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      white-space: nowrap;
      pointer-events: none; /* ไม่รับเหตุการณ์เมาส์ */
      margin: 0; /* ให้ offset ของ Marker ควบคุมตำแหน่ง */
    }
    
    /* สไตล์สำหรับหมุดจุดสีแดงเดิม */
    .red-dot-marker {
      width: 10px;
      height: 10px;
      background-color: #FF0000;
      border-radius: 100%;
      border: 1px solid white;
      box-shadow: 0 0 1px rgba(0,0,0,0.5);
      pointer-events: auto;
    }

    /* สไตล์สำหรับกล่องแสดงค่า Bearing (ทิศทางการหมุน) */
    #bearing-info {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
      border: 1px solid #333;
      z-index: 1;
    }
    
    /* สไตล์ใหม่สำหรับกล่องแสดงค่า Zoom Level */
    #zoom-info {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
      border: 1px solid #333;
      z-index: 1;
    }

    /* สไตล์สำหรับกล่องแสดงค่า Distance (ระยะห่าง) */
    #distance-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(255,255,255,0.8);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      border: 1px solid #333;
      z-index: 1;
      white-space: pre-line;
    }

    /* สไตล์สำหรับปุ่ม Reset ที่กำหนดเอง */
    .reset-button {
      background: white;
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 8px;
      cursor: pointer;
      margin: 5px;
      transition: transform 0.2s, background 0.3s;
    }
    .reset-button:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }

    /* ปรับปรุงปุ่ม Navigation Control ของ MapLibre */
    .maplibregl-ctrl-group > button {
      border-radius: 4px !important;
      margin: 2px !important;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      transition: transform 0.15s, background-color 0.2s;
    }
    .maplibregl-ctrl-group > button:hover {
      background-color: #f0f0f0;
      transform: scale(1.1);
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="bearing-info">Bearing: -45.60°</div>

<div id="zoom-info">Zoom: 15.65</div>

<div id="distance-info">
พิกัด: 99.535692, 11.231666
ระยะไปขอบล่าง: [กำลังคำนวณ] km 
ระยะไปขอบซ้าย: [กำลังคำนวณ] km
</div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
  // =======================================================
  // 1. การตั้งค่าแผนที่เบื้องต้น (Initial Setup)
  // =======================================================
  const targetLngLat = [99.535692, 11.231666]; 
  const desiredOffsetSouth = 0.0010;
  const desiredOffsetWest  = 0.0000;
  const initialBearing = -45.6;          
  const initialZoom = 15.65;
  const initialPitch = 0;                

  const angleRad = (initialBearing * Math.PI) / 180; 
  const offsetX_Lng = ((desiredOffsetWest * Math.cos(angleRad)) + (desiredOffsetSouth * Math.sin(angleRad)));
  const offsetY_Lat = ((desiredOffsetSouth * Math.cos(angleRad)) - (desiredOffsetWest * Math.sin(angleRad)));
  const center = [
      targetLngLat[0] - offsetX_Lng, 
      targetLngLat[1] - offsetY_Lat  
  ];

  const map = new maplibregl.Map({
    container: 'map', 
    style: {
      version: 8,
      sources: {
        satellite: {
          type: 'raster',
          tiles: [
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
          ],
          tileSize: 256
        }
      },
      layers: [
        { id: 'satellite', type: 'raster', source: 'satellite' }
      ]
    },
    center: center, 
    zoom: initialZoom,
    bearing: initialBearing,
    pitch: initialPitch,
    maxZoom: 17.39
  });

  // =======================================================
  // 2. Controls
  // =======================================================
  map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'bottom-right');

  class ResetControl {
    onAdd(map) {
      this.map = map;
      this.container = document.createElement('div');
      this.container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
      const btn = document.createElement('button');
      btn.className = 'reset-button';
      btn.innerHTML = "⟳";
      btn.title = "Reset View";
      btn.onclick = () => {
        map.easeTo({
          center: center, 
          zoom: initialZoom,
          bearing: initialBearing,
          pitch: initialPitch
        });
      };
      this.container.appendChild(btn);
      return this.container;
    }
    onRemove() {
      this.container.parentNode.removeChild(this.container);
      this.map = undefined;
    }
  }
  map.addControl(new ResetControl(), 'bottom-right');

  // =======================================================
  // 3. Bearing & Zoom Info
  // =======================================================
  const bearingInfo = document.getElementById('bearing-info');
  const zoomInfo = document.getElementById('zoom-info');

  function updateBearing() {
    const bearing = map.getBearing().toFixed(2);
    bearingInfo.innerText = `Bearing: ${bearing}°`;
  }
  function updateZoom() {
    const zoom = map.getZoom().toFixed(2); 
    zoomInfo.innerText = `Zoom: ${zoom}`;
  }
  map.on('rotate', updateBearing);
  map.on('zoom', updateZoom);
  map.on('load', updateBearing); 
  map.on('load', updateZoom); 

  // =======================================================
  // 4. Distance Info
  // =======================================================
  const distanceInfo = document.getElementById('distance-info');
  const targetPoint = targetLngLat; 

  function updateDistances() {
    const bounds = map.getBounds(); 
    const point = turf.point(targetPoint); 

    const south = turf.point([targetPoint[0], bounds.getSouth()]); 
    const west  = turf.point([bounds.getWest(), targetPoint[1]]);  

    const distSouth = turf.distance(point, south, {units: 'kilometers'}).toFixed(2);
    const distWest  = turf.distance(point, west,  {units: 'kilometers'}).toFixed(2);
    
    distanceInfo.innerText =
      `พิกัด: ${targetPoint[0]}, ${targetPoint[1]}\n` +
      `ระยะไปขอบล่าง: ${distSouth} km\n` +
      `ระยะไปขอบซ้าย: ${distWest} km`;
  }

  map.on('moveend', updateDistances);
  map.on('load', updateDistances); 

  // =======================================================
  // 5. Marker + Label (แก้ให้ไม่ซ้อนทับ)
  // =======================================================
  const markerPoint = targetLngLat; 

  // --- จุดแดง (marker) ---
  const markerDiv = document.createElement('div');
  markerDiv.className = 'red-dot-marker';

  // วางจุดแดงให้ anchor ที่ 'center' เพื่อให้จุดอยู่ตรงพิกัดกลาง
  new maplibregl.Marker({
    element: markerDiv,
    anchor: 'center'
  })
  .setLngLat(markerPoint)
  .addTo(map);

  // --- Label (ข้อความ) ---
  const labelDiv = document.createElement('div');
  labelDiv.className = 'custom-text-label';
  labelDiv.innerText = "1";

  // ขนาดของจุด (ตรงกับ CSS .red-dot-marker) เพื่อคำนวณ offset ให้ label ไม่ทับ
  const markerDotSize = 5; // px (เท่ากับ width/height ของ .red-dot-marker)
  const extraGap = 6; // px ช่องว่างเพิ่มระหว่างจุดกับ label (ปรับได้)
  // เราใช้ anchor 'bottom' สำหรับ label (จะวางขอบล่างของ label ที่พิกัด) 
  // แล้วเลื่อนขึ้นด้วย offset เป็นค่าลบ (พิกเซล)
  const offsetY = -(markerDotSize / 2 + extraGap); // ตัวอย่าง: -(5 + 6) = -11

  new maplibregl.Marker({
    element: labelDiv,
    anchor: 'bottom',
    offset: [0, offsetY]
  })
  .setLngLat(markerPoint)
  .addTo(map);

  // ถ้าต้องการปรับระยะห่าง ให้เปลี่ยนค่า extraGap (เพิ่ม = ห่างมากขึ้น)
</script>

</body>
</html>
