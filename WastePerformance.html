<!doctype html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Waste Bag Dashboard - ตัวอย่าง</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root{
            --bg:#f6f8f9;
            --card:#ffffff;
            --accent:#0a6847;
            --muted:#6b7280;
        }
        body{
            margin:0;
            font-family: "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;
            background:var(--bg);
            color:#111827;
        }
        .container{
            max-width:1200px;
            margin:20px auto;
            padding:18px;
        }
        header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            margin-bottom:16px;
        }
        header h1{
            margin:0;
            font-size:20px;
            color:var(--accent);
        }
        /* ปรับปรุง .controls ให้ยืดหยุ่นและมีช่องว่าง */
        .controls{
            display:flex;
            flex-wrap: wrap; 
            gap:8px;
            align-items:center;
        }
        .controls select, .controls input[type="date"], .controls input[type="number"] {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .filter-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        #loadingIndicator {
            color: var(--accent);
            font-weight: 600;
            margin-left: 10px;
            display: none; /* ซ่อนไว้เป็นค่าเริ่มต้น */
        }
        .btn{
            background:var(--accent);
            color:white;
            border:none;
            padding:8px 10px;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
        }
        .kpi{
            display:grid;
            grid-template-columns:repeat(5,1fr);
            gap:12px;
            margin-bottom:18px;
        }
        .card{
            background:var(--card);
            border-radius:10px;
            padding:12px;
            box-shadow:0 6px 18px rgba(10,10,10,0.04);
        }
        .card .title{font-size:13px;color:var(--muted);margin-bottom:6px;}
        .card .value{font-size:20px;font-weight:700;color:#111827;}
        .grid-two{
            display:grid;
            grid-template-columns: 1fr 420px;
            gap:16px;
            margin-bottom:16px;
        }
        .chart-wrap{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(10,10,10,0.04);}
        canvas{width:100% !important;height:320px !important;}
        table{
            width:100%;
            border-collapse:collapse;
            font-size:13px;
        }
        thead th{
            text-align:left;
            padding:8px;
            background:#f3f4f6;
            border-bottom:1px solid #e5e7eb;
        }
        tbody td{
            padding:8px;
            border-bottom:1px solid #eee;
        }
        .table-container{
            background:var(--card);
            border-radius:10px;
            padding:8px;
            box-shadow:0 6px 18px rgba(10,10,10,0.04);
            overflow:auto;
            max-height:420px;
        }
        .tools{
            display:flex;
            gap:8px;
            margin-bottom:8px;
            align-items:center;
        }
        .search{
            padding:8px 10px;
            border-radius:8px;
            border:1px solid #ddd;
            min-width:220px;
        }
        @media(max-width:980px){
            .kpi{grid-template-columns:repeat(2,1fr);}
            .grid-two{grid-template-columns:1fr;}
            canvas{height:260px !important;}
            /* ปรับปรุงให้ controls แสดงผลดีขึ้นในมือถือ */
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-inputs {
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WasteCheck Analytics</h1>
            <div class="controls">
                <select id="filterType">
                    <option value="day">กรองรายวัน</option>
                    <option value="month">กรองรายเดือน</option>
                    <option value="year">กรองรายปี</option>
                    <option value="">ทั้งหมด</option>
                </select>
                
                <div id="dayControls" class="filter-inputs">
                    <label for="filterDay">วันที่:</label>
                    <input type="date" id="filterDay" />
                </div>
                
                <div id="monthControls" class="filter-inputs" style="display:none;">
                    <label for="filterMonth">เดือน:</label>
                    <input type="number" id="filterMonth" min="1" max="12" style="width: 50px;">
                    <label for="filterYearM">ปี:</label>
                    <input type="number" id="filterYearM" min="2020" style="width: 70px;">
                </div>

                <div id="yearControls" class="filter-inputs" style="display:none;">
                    <label for="filterYearY">ปี:</label>
                    <input type="number" id="filterYearY" min="2020" style="width: 70px;">
                </div>
                
                <button class="btn" id="applyFilterBtn">กรองข้อมูล</button>
                <button class="btn" id="resetBtn">รีเซ็ต</button>
                <button class="btn" id="exportBtn">Export CSV</button>
                <span id="loadingIndicator">กำลังโหลด...</span>
            </div>
            </header>

        <section class="kpi" aria-label="KPI summary">
            <div class="card"><div class="title">ถุงแดงรวม</div><div class="value" id="totalRed">0</div></div>
            <div class="card"><div class="title">ถุงเขียวรวม</div><div class="value" id="totalGreen">0</div></div>
            <div class="card"><div class="title">ถุงดำรวม</div><div class="value" id="totalBlack">0</div></div>
            <div class="card"><div class="title">ถุงใส่เศษอาหารรวม</div><div class="value" id="totalFood">0</div></div>
            <div class="card"><div class="title">จำนวนจุดที่บันทึก</div><div class="value" id="totalLocations">0</div></div>
        </section>

        <section class="grid-two">
            <div class="chart-wrap">
                <canvas id="barChart"></canvas>
            </div>

            <div style="display:flex;flex-direction:column;gap:12px;">
                <div class="chart-wrap">
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="card" style="padding:10px;">
                    <strong>คำอธิบาย</strong>
                    <p style="margin:6px 0 0 0;color:var(--muted);font-size:13px;">
                      แผนภูมิวงกลม (Pie Chart) แสดงให้เห็นถึง สัดส่วนรวม ของจำนวนถุงแต่ละประเภท
                      แดง(ขยะอันตราย), เขียว(ขยะรีไซเคิล), ดำ(ขยะทั่วไป), เหลือง(ขยะเศษอาหาร)
                    </p>
                </div>
            </div>
        </section>

        <div class="table-container" style="margin-top:12px;">
            <div class="tools" style="justify-content:space-between;">
                <div style="display:flex;gap:8px;align-items:center;">
                    <input class="search" id="searchInput" placeholder="ค้นหาชื่อพื้นที่..." />
                    <select id="bagFilter" style="padding:8px;border-radius:8px;border:1px solid #ddd;">
                        <option value="">-- แสดงทุกประเภทถุง --</option>
                        <option value="red">ถุงแดง > 0</option>
                        <option value="green">ถุงเขียว > 0</option>
                        <option value="black">ถุงดำ > 0</option>
                        <option value="food">ถุงอาหาร > 0</option>
                    </select>
                </div>
                <div style="color:var(--muted);font-size:13px;">แสดงข้อมูลที่กรองแล้ว: <span id="rowsCount">0</span> แถว</div>
            </div>

            <table id="dataTable">
                <thead>
                    <tr>
                        <th>หมายเลข</th>
                        <th>พื้นที่</th>
                        <th>ถุงแดง</th>
                        <th>ถุงเขียว</th>
                        <th>ถุงดำ</th>
                        <th>ถุงอาหาร</th>
                        <th>วันที่</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzoDaY-EPmqPUlNf_TQEeOZ7IqbEgfsUZ6-8ViMOAXZXVsm5AhRvWUgb2hV8XzT7yozxQ/exec';
        
        // ข้อมูลที่ดึงมาจาก API ทั้งหมด (ตามการกรอง วัน/เดือน/ปี)
        let currentData = []; 
        // ข้อมูลที่ผ่านการกรอง Search/Bag Filter แล้ว (Client-side filter)
        let filteredData = []; 

        // ====== Helpers ======
        function formatNumber(n) { return Number(n).toLocaleString('en-US'); }

        // ====== Fetch, Compute KPIs and render table ======

        /**
         * สร้าง URL สำหรับเรียก API และดึงข้อมูล
         * @param {string} filterType - 'day', 'month', 'year', หรือ '' (ทั้งหมด)
         * @param {Object} params - พารามิเตอร์สำหรับ API
         */
        async function fetchData(filterType, params) {
            document.getElementById('loadingIndicator').style.display = 'inline';
            const urlParams = new URLSearchParams();
            let url = API_URL;

            if (filterType) {
                urlParams.append('type', filterType);

                if (filterType === 'day' && params.day) {
                    // Apps Script ต้องการวันที่ในรูปแบบ DD/MM/YYYY
                    const [year, month, day] = params.day.split('-');
                    urlParams.append('date', `${day}/${month}/${year}`);
                } else if (filterType === 'month' && params.month && params.year) {
                    urlParams.append('month', params.month);
                    urlParams.append('year', params.year);
                } else if (filterType === 'year' && params.year) {
                    urlParams.append('year', params.year);
                }
            } else {
                // Apps Script ที่คุณให้มาต้องการ parameter 'type' 
                // หากต้องการดึงข้อมูลทั้งหมดโดยไม่ระบุ type ต้องมีการแก้ไข Apps Script 
                // ในที่นี้จะลองเรียกโดยไม่มีพารามิเตอร์ (แต่จะไม่ได้ข้อมูลหาก Apps Script เป็นไปตามโค้ดต้นฉบับ)
            }

            if (urlParams.toString()) {
                url = `${API_URL}?${urlParams.toString()}`;
            }

            try {
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Mapping ข้อมูลจาก array of arrays [ID, Area, Red, Green, Black, Food, Date]
                    currentData = result.data.map(row => ({
                        id: row[0],
                        area: row[1],
                        red: Number(row[2] || 0),
                        green: Number(row[3] || 0),
                        black: Number(row[4] || 0),
                        food: Number(row[5] || 0),
                        // แปลงค่าวันที่จาก Apps Script (Timestamp/Date object) เป็น YYYY-MM-DD
                        datetime: row[6] ? new Date(row[6]).toISOString().split('T')[0] : '' 
                    }));
                } else {
                    console.error('API Error:', result);
                    currentData = [];
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                currentData = [];
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
            
            // หลังจากดึงข้อมูลเสร็จ ให้ทำการกรองฝั่ง Client-side ต่อ
            applyClientFilters();
        }

        function computeAndRender(data) {
            // Totals (KPIs)
            const totals = data.reduce((acc, row) => {
                acc.red += row.red;
                acc.green += row.green;
                acc.black += row.black;
                acc.food += row.food;
                return acc;
            }, { red: 0, green: 0, black: 0, food: 0 });

            document.getElementById('totalRed').innerText = formatNumber(totals.red);
            document.getElementById('totalGreen').innerText = formatNumber(totals.green);
            document.getElementById('totalBlack').innerText = formatNumber(totals.black);
            document.getElementById('totalFood').innerText = formatNumber(totals.food);
            document.getElementById('totalLocations').innerText = data.length;

            // Render table
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.id}</td>
                    <td>${r.area}</td>
                    <td>${r.red}</td>
                    <td>${r.green}</td>
                    <td>${r.black}</td>
                    <td>${r.food}</td>
                    <td>${r.datetime}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('rowsCount').innerText = data.length;

            // Update charts
            updateCharts(data, totals);
        }

        // ====== Charts ======
        let pieChart, barChart;

        function createCharts() {
            // (โค้ดสร้าง Chart.js ไม่ได้เปลี่ยนแปลงมากนัก)
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: ['ถุงแดง', 'ถุงเขียว', 'ถุงดำ', 'ถุงอาหาร'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#ef4444', '#10b981', '#111827', '#f59e0b'],
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: { legend: { position: 'bottom' } },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            const ctxBar = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'ถุงแดง', data: [], stack: 'stack1', backgroundColor: '#ef4444' },
                        { label: 'ถุงเขียว', data: [], stack: 'stack1', backgroundColor: '#10b981' },
                        { label: 'ถุงดำ', data: [], stack: 'stack1', backgroundColor: '#111827' },
                        { label: 'ถุงอาหาร', data: [], stack: 'stack1', backgroundColor: '#f59e0b' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { maxRotation: 40, minRotation: 0 } },
                        y: { stacked: true, beginAtZero: true }
                    },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function updateCharts(data, totals) {
            // Pie Chart
            pieChart.data.datasets[0].data = [totals.red, totals.green, totals.black, totals.food];
            pieChart.update();

            // Bar Chart (Group by Area)
            const labels = data.map(r => r.area);
            const redData = data.map(r => r.red);
            const greenData = data.map(r => r.green);
            const blackData = data.map(r => r.black);
            const foodData = data.map(r => r.food);

            barChart.data.labels = labels;
            barChart.data.datasets[0].data = redData;
            barChart.data.datasets[1].data = greenData;
            barChart.data.datasets[2].data = blackData;
            barChart.data.datasets[3].data = foodData;
            barChart.update();
        }

        // ====== Filtering & Search (Client-side) ======

        /**
         * ใช้สำหรับกรองข้อมูลจาก 'currentData' ด้วย Search/Bag Filter
         */
        function applyClientFilters() {
            const search = document.getElementById('searchInput').value.trim().toLowerCase();
            const bagFilter = document.getElementById('bagFilter').value;

            filteredData = currentData.filter(r => {
                if (search) {
                    if (!r.area.toLowerCase().includes(search)) return false;
                }
                if (bagFilter) {
                    // Client-side filtering for bag type > 0
                    if (bagFilter === 'red' && !(r.red > 0)) return false;
                    if (bagFilter === 'green' && !(r.green > 0)) return false;
                    if (bagFilter === 'black' && !(r.black > 0)) return false;
                    if (bagFilter === 'food' && !(r.food > 0)) return false;
                }
                return true;
            });

            computeAndRender(filteredData);
        }

        // ====== Filtering (Server-side API Call) ======

        /**
         * จัดการการคลิกปุ่ม "กรองข้อมูล" เพื่อเรียก API
         */
        function handleApplyFilter() {
            const filterType = document.getElementById('filterType').value;
            const params = {};

            if (filterType === 'day') {
                params.day = document.getElementById('filterDay').value;
                if (!params.day) {
                    alert('โปรดเลือกวันที่สำหรับการกรองรายวัน');
                    return;
                }
            } else if (filterType === 'month') {
                params.month = document.getElementById('filterMonth').value;
                params.year = document.getElementById('filterYearM').value;
                if (!params.month || !params.year) {
                    alert('โปรดใส่เดือนและปีสำหรับการกรองรายเดือน');
                    return;
                }
            } else if (filterType === 'year') {
                params.year = document.getElementById('filterYearY').value;
                if (!params.year) {
                    alert('โปรดใส่ปีสำหรับการกรองรายปี');
                    return;
                }
            } else {
                 // filterType === '' (ทั้งหมด)
                 // จะเรียก API โดยไม่มีพารามิเตอร์ ซึ่ง Apps Script อาจจะคืนค่าเป็นชุดข้อมูลว่าง
            }

            fetchData(filterType, params);
        }

        /**
         * สลับการแสดง Input ตามประเภทการกรองที่เลือก
         */
        function switchFilterControls() {
            const type = document.getElementById('filterType').value;
            document.getElementById('dayControls').style.display = 'none';
            document.getElementById('monthControls').style.display = 'none';
            document.getElementById('yearControls').style.display = 'none';

            if (type === 'day') {
                document.getElementById('dayControls').style.display = 'flex';
            } else if (type === 'month') {
                document.getElementById('monthControls').style.display = 'flex';
            } else if (type === 'year') {
                document.getElementById('yearControls').style.display = 'flex';
            }
        }

        // ====== Export CSV ======
        function exportCSV() {
            const rows = [
                ['หมายเลข', 'พื้นที่', 'ถุงแดง', 'ถุงเขียว', 'ถุงดำ', 'ถุงอาหาร', 'วันที่']
            ];
            // ใช้ filteredData ซึ่งเป็นข้อมูลที่แสดงอยู่ในตารางปัจจุบัน
            filteredData.forEach(r => {
                rows.push([r.id, r.area, r.red, r.green, r.black, r.food, r.datetime]);
            });
            const csvContent = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // เพิ่ม BOM สำหรับภาษาไทย
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wastebags_export_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ====== Init ======
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() is 0-indexed

            // กำหนดค่าเริ่มต้น
            const todayISO = now.toISOString().split('T')[0];
            document.getElementById('filterDay').value = todayISO;
            document.getElementById('filterMonth').value = currentMonth;
            document.getElementById('filterYearM').value = currentYear;
            document.getElementById('filterYearY').value = currentYear;
            document.getElementById('filterType').value = 'day'; // กำหนดให้กรองรายวันเป็นค่าเริ่มต้น

            createCharts();
            
            // โหลดข้อมูลเริ่มต้นตามค่าเริ่มต้น (กรองรายวัน)
            switchFilterControls();
            handleApplyFilter(); 

            // Listeners
            document.getElementById('filterType').addEventListener('change', switchFilterControls);
            document.getElementById('applyFilterBtn').addEventListener('click', handleApplyFilter);
            
            // Client-side listeners: กรองข้อมูลที่ถูกดึงมาแล้ว
            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(window._searchT);
                window._searchT = setTimeout(applyClientFilters, 200);
            });
            document.getElementById('bagFilter').addEventListener('change', applyClientFilters);
            document.getElementById('exportBtn').addEventListener('click', exportCSV);
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                // รีเซ็ตตัวกรอง Date/Time
                document.getElementById('filterType').value = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('bagFilter').value = '';
                switchFilterControls();
                
                // โหลดข้อมูลทั้งหมดอีกครั้ง (ถ้า Apps Script รองรับ) หรือโหลดตามค่าเริ่มต้น
                fetchData('', {});
            });
        });
    </script>
</body>
</html>
